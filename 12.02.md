### Linux 端口无法访问
> 没开放`127.0.0.1` 地址访问

### Redis笔记02 - node-redis探究
创建客户端实例
```javascript
function RedisClient (options, stream) {
    ...
    this.create_stream();
    ...
}
```
执行command
```javascript
RedisClient.prototype.internal_send_command = function (command_obj) {
    ...
    this.write(command_str);
    ...
}
```
执行方法，压入命令
```javascript
RedisClient.prototype.write = function (data) {
    if (this.pipeline === false) {
        this.should_buffer = !this.stream.write(data); // 向服务器发送请求
        return;
    }
    this.pipeline_queue.push(data);
};
```

接收结果
```javascript
RedisClient.prototype.create_stream = function () {
    ...
    // 创建stream
    if (this.options.tls) {
        this.stream = tls.connect(this.connection_options);
    } else {
        this.stream = net.createConnection(this.connection_options);
    }
    ...
    // 接受返回结果
    this.stream.on('data', function (buffer_from_socket) {
        debug('Net read ' + self.address + ' id ' + self.connection_id);
        self.reply_parser.execute(buffer_from_socket); // 解析方法
        self.emit_idle(); //
    });
    ...
}
```

### Linux nc
```
-l 监听
-v 显示执行过程
-w wait x秒

端口扫描
nc -v -w1 -z localhost 1-22
传输信息
server1: nc -l port
server2: nc server1 port < content.txt
```
> 参考: https://www.cnblogs.com/wenbiao/p/3375811.html

### promisify内部实现
工作里用到了promisify,查看下实现原理
#### 使用
```javascript
const { promisify } = require('util');
const f = function (str, cb) {
    setTimeout(() => {
        console.log(str)
        cb();
    }, 2 * 1000);
};
```
未promisify之前
```javascript
(async () => {
    console.log('start');
    f('f', () => {
        console.log('end');
    });
})();
// 结果:
// > start
// ...等2s
// > f
// > end
```
promisify化
```javascript
(async () => {
    console.log('start');
    let pf = promisify(f);
    await pf('f');
    // await pf('f', () => {console.log('callback end')});
    console.log('end');
})();
// 结果：
// > start
// ...等2s
// > f
// > end
```

promisify化,任然使用callback
```javascript
(async () => {
    console.log('start');
    let pf = promisify(f);
    // await pf('f');
    await pf('f', () => {console.log('callback end')});
    console.log('end');
})();
// 结果：
// > start
// ...等2s
// > f
// > callback end
```
#### 源码
```javascript
function fn(...args) {
    const promise = createPromise();
    try {
        // args不能带原来的callback参数，否则不能返回promise
        original.call(this, ...args, (err, ...values) => {
            if (err) {
                promiseReject(promise, err);
            } else if (argumentNames !== undefined && values.length > 1) {
                // 返回多个值
                const obj = {};
                for (var i = 0; i < argumentNames.length; i++)
                    obj[argumentNames[i]] = values[i];
                promiseResolve(promise, obj);
            } else {
                // 只有一个返回值
                promiseResolve(promise, values[0]);
            }
        });
    } catch (err) {
        promiseReject(promise, err);
    }
    return promise;
}
// 保持原型链一致
Object.setPrototypeOf(fn, Object.getPrototypeOf(original));

// 定义kCustomPromisifiedSymbol 属性
// kCustomPromisifiedSymbol 用于已promisify的属性
Object.defineProperty(fn, kCustomPromisifiedSymbol, {
    value: fn,
    enumerable: false,
    writable: false,
    configurable: true
});
// 保持fn 和 original其他属性一致
return Object.defineProperties(
    fn,
    Object.getOwnPropertyDescriptors(original)
);
```

